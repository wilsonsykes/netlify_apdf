<script>
  function getRecipientIdFromUrl() {
    const url = new URL(window.location.href);
    const pathParts = url.searchParams.get('pdf')?.split('/');
    return pathParts?.[1] || 'unknown_recipient';
  }

  const canvas = document.getElementById('signature-canvas');
  const ctx = canvas.getContext('2d');
  let isDrawing = false;

  canvas.addEventListener('mousedown', (e) => {
    isDrawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  });
  canvas.addEventListener('mousemove', (e) => {
    if (isDrawing) {
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    }
  });
  canvas.addEventListener('mouseup', () => {
    isDrawing = false;
  });

  document.getElementById('clear-button').onclick = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  document.getElementById('sign-download').onclick = () => {
    const link = document.createElement('a');
    link.download = 'signature.png';
    link.href = canvas.toDataURL();
    link.click();
  };

  document.getElementById('sign-upload').onclick = async () => {
    const recipientId = getRecipientIdFromUrl();
    canvas.toBlob(async function (blob) {
      const formData = new FormData();
      formData.append('recipient_id', recipientId);
      formData.append('signed_pdf', blob, `${recipientId}.png`);

      try {
        const response = await fetch('https://your-n8n-domain/webhook/signed-upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        alert('✅ Signature uploaded successfully!');
        console.log(result);
      } catch (err) {
        console.error('❌ Upload failed:', err);
        alert('❌ Upload failed. Please try again.');
      }
    }, 'image/png');
  };

  // PDF Viewer remains unchanged
  const urlParams = new URLSearchParams(window.location.search);
  const pdfUrl = urlParams.get('pdf');
  const pdfViewer = document.getElementById('pdf-viewer');
  const errorMsg = document.getElementById('error-msg');

  if (!pdfUrl) {
    pdfViewer.style.display = 'none';
    errorMsg.style.display = 'block';
  } else {
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    loadingTask.promise.then(function (pdf) {
      for (let i = 1; i <= pdf.numPages; i++) {
        pdf.getPage(i).then(function (page) {
          const scale = 1;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          pdfViewer.appendChild(canvas);
          page.render({ canvasContext: context, viewport });
        });
      }
    });
  }
</script>
