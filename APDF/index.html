<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Your Document</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      margin: 2rem;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    canvas {
      border: 1px dashed #aaa;
      width: 100%;
      height: 200px;
    }
    button {
      padding: 10px 15px;
      margin: 0.5rem;
      font-size: 1rem;
    }
    iframe {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìù Please Review and Sign Your Document</h2>
    <p>Your document is shown below. Please review and sign using the canvas below.</p>

    <iframe id="pdf-frame" src="" frameborder="0"></iframe>

    <h3>Sign below:</h3>
    <canvas id="signature-pad"></canvas>
    <div>
      <button id="clear-signature">Clear</button>
      <button id="sign-upload-btn">Sign & Upload</button>
    </div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

  <script>
    // Extract pdf URL param
    const urlParams = new URLSearchParams(window.location.search);
    const pdfPath = urlParams.get('pdf');
    const recipientId = pdfPath?.split("/")[1] || 'unknown';

    // Show PDF in iframe
    if (pdfPath) {
      document.getElementById('pdf-frame').src = pdfPath;
    }

    // Init signature canvas
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    canvas.addEventListener("mousedown", (e) => {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener("mousemove", (e) => {
      if (drawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener("mouseup", () => drawing = false);
    document.getElementById("clear-signature").onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Upload to webhook
    document.getElementById('sign-upload-btn').addEventListener('click', async function () {
      canvas.toBlob(async function (blob) {
        const formData = new FormData();
        formData.append('recipient_id', recipientId);
        formData.append('signed_pdf', blob, `${recipientId}.png`);

        try {
          const response = await fetch('https://n8n.apdi2025.site/webhook/signed-upload', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          alert('Signature submitted successfully!');
          console.log(result);
        } catch (err) {
          console.error('Upload error:', err);
          alert('Upload failed.');
        }
      }, 'image/png');
    });
  </script>
</body>
</html>
